name: HTML Quality Check

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to scan"
        required: true
      repo:
        description: "Repositorio"  
        required: true

jobs:
  scan-html:
    runs-on: ubuntu-latest
    outputs:
     status: ${{ steps.html_check.outputs.status }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        repository: mvthivs23/${{ github.event.inputs.repo }}
        ref: ${{ github.event.inputs.branch }}
    - name: Clone the repository to be scanned
      run: |
          git clone --branch ${{ github.event.inputs.branch }} https://github.com/mvthivs23/${{ github.event.inputs.repo }} target_repo
          ls -la target_repo

    - name: Run HTML Quality Check
      id: html_check
      run: |
          echo "Running HTML quality check..."

          REPO_DIR="target_repo"

          if [ -d "$REPO_DIR" ]; then
            echo "Scanning HTML files in $REPO_DIR..."
            
            # Define the pattern to search for in comments
            PATTERN="<!--.*-->"

            # Search for comments in HTML files
            MATCHES=$(grep -r -iE "$PATTERN" "$REPO_DIR"/*.html || true)

            # Write result to file
            echo "Repository: ${{ github.event.inputs.repo }}" > result.txt
            echo "Branch: ${{ github.event.inputs.branch }}" >> result.txt
            echo "Component: HTML Quality Check" >> result.txt
            echo "" >> result.txt

            if [ -n "$MATCHES" ]; then
              echo "Comentarios encontrados en los archivos HTML:" >> result.txt
              echo "$MATCHES" >> result.txt
              echo "" >> result.txt
              echo "El VB ha sido rechazado." >> result.txt
              echo "-------------------------------------" >> result.txt
              echo "status=fail" >> $GITHUB_ENV
            else
              echo "No se encontraron comentarios en los archivos HTML." >> result.txt
              echo "El VB ha sido aprobado." >> result.txt
              echo "-------------------------------------" >> result.txt
              echo "status=pass" >> $GITHUB_ENV
            fi
          else
            echo "Error: Directory $REPO_DIR does not exist."
            exit 1
          fi

  upload-result:
    runs-on: ubuntu-latest
    needs: scan-html
    steps:
      - name: Upload result file
        uses: actions/upload-artifact@v3
        with:
          name: html-quality-result
          path: result.txt